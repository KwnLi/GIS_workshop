---
title: "Conduct buffer analysis"
output:
  html_document:
    toc: true
    toc_depth: 3
---

```{r images, echo=FALSE}
# Define variable containing url
img1_buffers <- "http://wiki.gis.com/wiki/images/9/9c/BufferExamples.jpg"

img2_Avelino <- "https://drive.google.com/uc?export=view&id=1paWz37FjfCZMgYzteZZISJ0Ks-cx5S8e"

img3_landcover <- "https://drive.google.com/uc?export=view&id=1pb-YLRV4TOHk5F5KD-bSTqMdUxJwkAdl"

img4_veglayers <- "https://drive.google.com/uc?export=view&id=1pp2RkdDiMXk-GT5GuBXKS5meGdogEHu9"

img5_datasrcmngr <- "https://drive.google.com/uc?export=view&id=1pyRPXxfQYRVgMIOQBn7aeAm2xalo73eJ"

img6_windatasrcmngr <- "https://drive.google.com/uc?export=view&id=1q5STdCGDngJ5qyX8d8U8sxeDPRk_vOM0"

img7_savelayer <- "https://drive.google.com/uc?export=view&id=1qCKZQWc6cGulk_PEefp90-PY8HInyokw"

img8_menubuffer <- "https://drive.google.com/uc?export=view&id=1qVYfzRirx2fKf4H1wz2eHl_ajDA7jcKC"

img9_winbuffer <- "https://drive.google.com/uc?export=view&id=1qaEmKZ1AQ14c4enhZ_PMARaZxmxs5nnw"

img10_prbw <- "https://drive.google.com/uc?export=view&id=1qqNOY6sibqg7OCmxJbOI1YN87giYDhBm"

img11_winattb <- "https://drive.google.com/uc?export=view&id=1qqU8SO5F8dOEgqnRQTEJfnEqlQ40Vod_"

img12_prcol <- "https://drive.google.com/uc?export=view&id=1qr2mka-AzKeX3Oth53AnhUGlXTKCF8mi"

img13_winzon <- "https://drive.google.com/uc?export=view&id=1qyoZRDm8UkuZcSkWswVWGuvHQFAmC5ME"

img14_winqgis <- "https://drive.google.com/uc?export=view&id=1r19cbSqKBDny34syZs33ejOTapvcf8Pf"

```


## 1. Background

### What are buffers?

In GIS, buffers are a zone that is drawn around a geographic feature like a point, line, or polygon. The "buffer distance" defines how far the edges of the buffer zone are from the target feature that's being buffered.

Creating a buffer around a point results in a circle with a radius equal to the buffer distance.

<center><img src="`r img1_buffers`"></center>

**Figure 1** Examples of buffers around a point, a line, and a polygon. [1]

$$\\[0.1cm]$$

### What can be done with buffers?

Buffers can be used to delineate an area that might be relevant, ecologically. For example, wild pollinators or natural enemies may require forest for habitat. To quantify the amount of forest around a farm, you could create a buffer around it and measure the total amount of forest within this buffer. You could also perform other statistics to summarize the composition and configuration of land covers (habitats) within the buffer.

In the example below, 500m and 1500m buffers have been placed around locations in a coffee growing landscape in Turrialba, Costa Rica. The study [2] was looking at the correlation between different land cover types and the incidence of coffee berry borer, coffee leaf rust, and root-knot nematodes.

<center><img src="`r img2_Avelino`" style="width: 650px; max-width: 100%; height: auto"></center>

**Figure 2** An example of buffers placed in a coffee-growing landscape in Turrialba, Costa Rica. From Avelino et al., 2012. [2]

$$\\[0.1cm]$$

### Land cover data

The other component to performing a buffer analysis is the land cover layer. This is basically a map that covers the region of interest. It differentiates all areas into different "land cover classes", e.g., "forest", "row crops", "pasture", etc. We use the buffer to define only the portion we're interested in, for quantification and further analysis.

Land cover data can be generated by classifying remote sensing images (e.g., from satellites or aerial photos). This process can be automated using algorithms, or could be done manually by identifying and drawing boundaries of different land covers by hand.

<center><img src="`r img3_landcover`"></center>

**Figure 3** Illustration of the process of creating land cover data. In this case, the land cover data is derived from Landsat TM remote sensing imagery. [3]

$$\\[0.1cm]$$

## 2. GIS overview

Today we will use QGIS to:

1. Create points to represent the locations of 26 farms in Puerto Rico based on their geographic coordinates.

2. Find and load land cover data.

3. Create a buffer around each of the farm points.

4. Extract counts of the land cover classes within each buffer and export them to an Excel file.

$$\\[0.1cm]$$

### Notes about GIS data types

Today we will be working with two forms of GIS data: **vector** and **raster**.

**Vectors** are points, lines, and polygons. They are built around coordinates that the define the points and vertices of these geometries. The farm points and the buffers will be in vector data.

**Rasters** are grids of data that maps an entire region completely. Each cell of the grid covers and summarizes a regular, defined component area within the region (e.g. a square). The land cover data we will use will be in a raster format where each grid cell signifies the land cover within a 30x30m area (estimated by majority coverage).

$$\\[0.1cm]$$

### Data downloads

#### You need QGIS:

**QGIS Download Site:** https://qgis.org/en/site/forusers/download.html

$$\\[0.05cm]$$

#### You need two data layers:

[1. Farm coordinates](https://drive.google.com/uc?export=download&id=1dvNtK4ZrTTOdCIiYh9DzIgczzSSPP8yK)

[2. Land cover data (zipped)](https://drive.google.com/uc?export=download&id=1put6aO5vG6tDRX7r0a9Leb3KQti3YxuN)

$$\\[0.05cm]$$

#### More about the land cover data:

We will be using land cover data from the [USGS LANDFIRE dataset](https://landfire.gov/index.php). It has many different layers and its main focus is mapping and predicting wildfires, but it also includes useful data layers including vegetation classifications. Its most recent version is based on 2016 satellite data.

You can download the full set of LANDFIRE data for Puerto Rico here: https://landfire.gov/getdata.php . Under "Full Extent Mosaics", click on the "Download Insular Areas" link. Then select the link for "Puerto Rico, US Virgin Island" (the 2016 version).

There many different layers included in this download (it's 120 MB). A description of them all can be found in this [pdf](https://landfire.gov/documents/LF_Product_Descriptions_Table_2019.pdf). 
We are interested in the "National Vegetation Class" layer. For your information, here are some other layers related to vegetation that might be of interest (from the pdf above):

**Table 1** Vegetation layers available in the LANDFIRE dataset.

<center><img src="`r img4_veglayers`"></center>

$$\\[0.1cm]$$

## 3. Create points from farm coordinates

We have coordinates taken within each of the farms we want to create buffers around. Our first step needs to be to load these coordinates into QGIS by converting them to point data.

Here's a basic overview of the QGIS program window, highlighting some of the areas we are using in this workshop.

<left><img src="`r img14_winqgis`"></left>

#### a. Open a new project in QGIS.

#### b. Open the "Data Source Manager"

It looks like this:

<left><img src="`r img5_datasrcmngr`"></left>

#### c. Choose "Delimited Text" in the vertical bar to the left to load the farm coordinate file

Under **File name** find the coordinate file. Make sure the longitude column ("lon") is selected as the **X field** and the latitude column ("lat") as the **Y field**, under the section for "Geometry Definition"

Also make sure **Geometry CRS** is "EPSG:4326 - WGS 84". This is specific to these coordinates and will not always work for all data! See the GPS workshop for more information about coordinate systems.

Click **Add** and then **Close**

<left><img src="`r img6_windatasrcmngr`"></left>

$$\\[0.1cm]$$

The layer will be shown on the viewing window. However, this is a temporary layer. In order to do analysis on it you must save it.

#### d. Export the layer and change the coordinate system to a projected coordinate system

In the *Layers* panel (lower left), control/right click the newly-added layer and select **Export > Save Features As...**

Select **Format** as "GeoPackage", which is QGIS's format.

Select a file name and location

**Importantly, change the CRS to a projected coordinate system.** Click the button next to the **CRS** section to bring up the "Coordinate Reference System Selector". Use the **Filter** function to search for a *projected* coordinate system for Puerto Rico (search for Puerto Rico).

<left><img src="`r img7_savelayer`"></left>

$$\\[0.1cm]$$

## 4. Create buffers around farm points

#### a. Open the Buffer window

Under the **Vector** menu on the top menu bar, select **Geoprocessing Tools > Buffer**

<left><img src="`r img8_menubuffer`"></left>

#### b. Create a buffer around the farm points layer

Under **Input layer**, select the farm points layer you created.

Under **Distance**, choose the buffer distance, i.e. the radius of the circle to be created around each point. For example, 500 meters.

Use **Segments** to define the number of line segments used to make a quarter circle of the buffer. With Segments = 5, the buffer will be approximated by a 20-sided polygon.

***Note:*** You can use **Run as Batch Process...** if you want to repeatedly run this buffer tool (e.g. to repeat the buffer at different distances).

<left><img src="`r img9_winbuffer`"></left>

$$\\[0.1cm]$$

## 5. Load the LANDFIRE data

#### a. Load LANDFIRE layer

Open the **Data Source Manager** again (see 3b.)

In the *Data Source Manager* window, select the **Raster** tab in the vertical menu bar to the left.

Under **Source** navigate to the downloaded LANDFIRE vegetation class raster data. This should be "LV16_NVC_200.tif". Make sure the file name ends with **.tif**.

Click **Add** and then **Close**.

#### b. Adjust the display of the vegetation class layer

So far, the loaded LANDFIRE data for Puerto Rico appears in grayscale. This is because QGIS does not know that the data in the raster layer represent categories of land cover rather than continuous values. 

<left><img src="`r img10_prbw`"></left>

The color display information, as well as the definitions for the land cover codes are actually stored within the raster data for this format (GeoTIFF). However, you have to install a plugin (**RasterAttributeTable**) to be able to access this data.

Under the **Plugins** menu on the top menu bar, select **Manage and Install Plugins**.

In the *Plugins* window, search for "RasterAttributeTable" and click **Install Plugin**.

After you have installed the plugin, control/right click on the land cover layer and select "Open Attribute Table".

In the attribute table, you can check out all the land cover/vegetation classes in this layer and their total counts. In order to display the intended color of all the vegetation classes, click on the **Classify** button in the upper right corner. This will change the colors of the land cover layer. The colors of the categories are also shown as the background of the leftmost column of the attribute table.

<left><img src="`r img11_winattb`"></left>


<left><img src="`r img12_prcol`"></left>

$$\\[0.1cm]$$

## 6. Extract land cover statistics for each buffer

#### a. Open the "Zonal Histogram" tool in the Processing Toolbox Panel

If you cannot find the **Processing Toolbox** panel, make sure it's activated by going to **View > Panels > Processing Toolbox** and checking the box.

In the **Processing Toolbox**, expand *Raster analysis* and select **Zonal Histogram**

In the *Zonal Histogram* window, under **Raster layer**, select the LANDFIRE layer.

Under **Vector layer containing zones**, select the layer for the farm buffers.

Optionally, you can change the prefix for the columns representing each land cover type.

***Note:*** As with the buffer tool, you can use **Run as Batch Process...** if you want to repeatedly run the tool (e.g. to repeat the extraction for multiple buffers).

<left><img src="`r img13_winzon`"></left>

$$\\[0.1cm]$$

#### b. Export data to excel

In the *Layers* panel, control/right click the new output result from the Zonal Histograms tool. Select **Export>Save Vector Layer as...**.

Select the format to be **MS Office Open XML spreadsheet [XLSX]** or **Comma separated value [CSV]**

Select a output file name and folder and click **OK**.

$$\\[0.1cm]$$

## 7. Examine the output table

The output data table contains multiple columns with the prefix specified by the *Zonal Histogram* tool followed by a code representing the land cover class. 

The values in these columns represent the count of total **pixels** covered by the buffer. This does not represent area directly. To convert to area, multiply the pixel count by the size of each cell (pixel). Since the LANDFIRE dataset has 30x30m cells, the number of pixels should be multiplied by 900 to arrive at the estimated area.

$$\\[0.1cm]$$

## 8. Extra Credit

### Make buffers with R.

R can help make this process faster if you want to run many buffers and create and analyze many outputs. Here are instructions for doing the same thing with R: https://kwnli.github.io/GIS_workshop/02_BuffersWithR.html


### More functions to summarize the data within a buffer

Other functions can be used to summarize the land cover or other landscape data inside a buffer. For example, the [Zonal Statistics tool](https://docs.qgis.org/3.16/en/docs/user_manual/processing_algs/qgis/rasteranalysis.html#zonal-statistics) in QGIS could be useful for summarizing continuous values (e.g. percent canopy cover).

With R, the package [LandscapeMetrics](https://r-spatialecology.github.io/landscapemetrics/) allows you to calculate even more statistics, though not based on buffers. This includes things like total edge length within a landscape.

$$\\[0.1cm]$$

## References
1. http://wiki.gis.com/wiki/index.php/Buffer_(GIS)

2. Avelino, J., Romero-Gurdián, A., Cruz-Cuellar, H. F. & Declerck, F. A. J. Landscape context and scale differentially impact coffee leaf rust, coffee berry borer, and coffee root-knot nematodes. *Ecological Applications* 22, 584–596 (2012).

3. By Uddinkabir - Own work, CC BY-SA 4.0, https://commons.wikimedia.org/w/index.php?curid=41183128
